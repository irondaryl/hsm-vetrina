<section class="reviews section fade-in-up">
  <div class="reviews__header">
    <h2 class="headline-bar">Recensioni su HSM</h2>
    <p class="section__lead">
      Lascia un feedback sul concept, sul sito o sulla piattaforma.
    </p>
  </div>

  <!-- Login / Info utente -->
  <div class="reviews__auth">
    <!-- Se NON sono loggato, mostro un semplice bottone -->
    <ng-container *ngIf="!user; else loggedBlock">
      <button class="btn btn-primary" (click)="signInWithGoogle()">
        Accedi con Google per recensire
      </button>
    </ng-container>

    <!-- Se sono loggato -->
    <ng-template #loggedBlock>
      <div class="reviews__user">
        <img
          *ngIf="user?.photoUrl as photo"
          [src]="photo"
          alt="avatar"
          class="reviews__avatar"
        />

        <div>
          <div class="reviews__user-name">{{ user?.name }}</div>
          <button class="btn btn-ghost btn-xs" (click)="signOut()">
            Esci
          </button>
        </div>
      </div>
    </ng-template>
  </div>

  <!-- Form recensione (solo se loggato) -->
  <form
    class="reviews__form"
    [formGroup]="form"
    (ngSubmit)="onSubmit()"
    *ngIf="user"
  >
    <div class="form-row">
      <label>Valutazione</label>
      <div class="stars">
        <label
          *ngFor="let r of [1, 2, 3, 4, 5]"
          [class.stars__star--active]="r <= form.value.rating"
        >
          <input
            type="radio"
            formControlName="rating"
            [value]="r"
            [checked]="r === form.value.rating"
          />
          ★
        </label>
      </div>
    </div>

    <div class="form-row">
      <label for="comment">Commento</label>
      <textarea
        id="comment"
        rows="3"
        formControlName="comment"
        placeholder="Scrivi cosa ti è piaciuto, cosa miglioreresti..."
      ></textarea>
    </div>

    <button
      class="btn btn-primary"
      type="submit"
      [disabled]="form.invalid || loading"
    >
      Pubblica recensione
    </button>
  </form>

  <!-- Lista recensioni -->
  <div class="reviews__list">
    <article class="reviews__item" *ngFor="let r of reviews">
      <div class="reviews__item-header">
        <div class="reviews__item-author">
          <img
            *ngIf="r.authorAvatarUrl"
            [src]="r.authorAvatarUrl"
            alt="avatar"
            class="reviews__avatar"
          />
          <div>
            <div class="reviews__item-name">{{ r.authorName }}</div>
            <div class="reviews__item-rating">
              <span *ngFor="let s of [1, 2, 3, 4, 5]">
                {{ s <= r.rating ? '★' : '☆' }}
              </span>
            </div>
          </div>
        </div>
        <div class="reviews__item-date">
          {{ r.createdAt | date: 'dd/MM/yyyy' }}
        </div>
      </div>

      <p class="reviews__item-comment">
        {{ r.comment }}
      </p>
    </article>
  </div>
</section>
